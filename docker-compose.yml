services:
  persona-chatbot:
    build:
      context: .
      dockerfile: Dockerfile.full
    user: "${UID:-1000}:${GID:-1000}"
    container_name: persona_chatbot_server
    ports:
      - "127.0.0.1:${WS_PORT:-8765}:8765"  # WebSocket (로컬 전용)
      - "127.0.0.1:${HTTP_PORT:-9000}:9000"  # HTTP (로컬 전용)
    volumes:
      - ./STORIES:/app/STORIES  # 서사 파일 마운트
      - ./server:/app/server    # 개발 중 코드 수정 반영
      - ./web:/app/web          # 개발 중 웹 파일 수정 반영
      - ./persona_data:/app/persona_data  # 프리셋/워크스페이스 공유
      - ./chatbot_workspace:/app/chatbot_workspace  # CLAUDE 지침/작업 폴더 공유
      - ${FACTORY_AUTH_DIR?set FACTORY_AUTH_DIR}:/home/node/.factory     # Droid 커스텀 모델/인증 정보
      - ${CLAUDE_AUTH_DIR?set CLAUDE_AUTH_DIR}:/home/node/.claude       # Claude OAuth 인증 정보 (선택)
      - ${GEMINI_AUTH_DIR?set GEMINI_AUTH_DIR}:/home/node/.config/gemini # Gemini OAuth 인증 정보 (선택)
    environment:
      - PYTHONUNBUFFERED=1
      - CLAUDE_PATH=claude
      - DROID_PATH=droid
      - GEMINI_PATH=gemini
      - FACTORY_API_KEY=${FACTORY_API_KEY:-}
      - DROID_SKIP_PERMISSIONS_UNSAFE=1
      - APP_LOGIN_PASSWORD=${APP_LOGIN_PASSWORD:-}
      - APP_JWT_SECRET=${APP_JWT_SECRET:-}
      - APP_JWT_TTL=${APP_JWT_TTL:-604800}
      - APP_BIND_HOST=${APP_BIND_HOST:-0.0.0.0}
      - FACTORY_AUTO_UPDATE=0
    stdin_open: true
    tty: true

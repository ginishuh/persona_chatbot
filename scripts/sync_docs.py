#!/usr/bin/env python3
"""
ë¬¸ì„œ ë™ê¸°í™” ìŠ¤í¬ë¦½íŠ¸

ë² ì´ìŠ¤ ì˜ë¬¸ ë¬¸ì„œ(`docs/agents_base_en.md`)ë¡œë¶€í„°
ë‹¤ìŒ íŒŒì¼ì„ ìë™ ë³µì œí•©ë‹ˆë‹¤.
- `AGENTS.md`
- `CLAUDE.md`
- `GEMINI.md`
- `.github/copilot-instructions.md` (ì½”ë“œë¦¬ë·°ìš©)
- `.github/instructions/review-language.instructions.md` (Korean-only ë¦¬ë·° ê·œì¹™)

ì‹¤í–‰ ë°©ë²•:
    python3 scripts/sync_docs.py
"""

from pathlib import Path
from textwrap import dedent


def sync_docs() -> bool:
    """ë² ì´ìŠ¤ ë¬¸ì„œë¡œë¶€í„° replica ë¬¸ì„œë¥¼ ë™ê¸°í™”í•©ë‹ˆë‹¤.

    Returns:
        True on success, False on failure.
    """

    base_en = Path("docs/agents_base_en.md")
    base_ko = Path("docs/agents_base_ko.md")  # ì¡´ì¬ ì—¬ë¶€ë§Œ í™•ì¸ (ì–¸ì–´ ì •ì±… ìœ ì§€)

    targets = [
        ("AGENTS.md", "Codex (Codex CLI)"),
        ("CLAUDE.md", "Anthropic Claude"),
        ("GEMINI.md", "Google Gemini"),
        (".github/copilot-instructions.md", "GitHub Copilot"),
    ]

    if not base_en.exists() or not base_ko.exists():
        missing = []
        if not base_en.exists():
            missing.append(str(base_en))
        if not base_ko.exists():
            missing.append(str(base_ko))
        print(f"âŒ ë² ì´ìŠ¤ ë¬¸ì„œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: {', '.join(missing)}")
        return False

    print("ğŸ“š ë¬¸ì„œ ë™ê¸°í™” ì‹œì‘...")

    base_content = base_en.read_text(encoding="utf-8")

    # Ensure directories
    Path(".github").mkdir(parents=True, exist_ok=True)
    Path(".github/instructions").mkdir(parents=True, exist_ok=True)

    for path_str, target_name in targets:
        path = Path(path_str)
        header = dedent(
            f"""> Replica target: {target_name}
> SSOT: docs/agents_base_en.md
> Do not edit this file; edit the base and run scripts/sync_docs.py.
"""
        )
        if path.name == "copilot-instructions.md":
            header += "> REVIEW-LANGUAGE: Korean only â€” write all code-review comments in Korean (í•œêµ­ì–´).\n\n"
        else:
            header += "\n"

        print(f"ğŸ“ {path} ë™ê¸°í™”...")
        try:
            path.write_text(header + base_content, encoding="utf-8", newline="\n")
            print(f"âœ… {path} ì—…ë°ì´íŠ¸ ì™„ë£Œ")
        except Exception as e:
            print(f"âŒ {path} ë³µì œ ì‹¤íŒ¨: {e}")
            return False

    # Copilot ë¦¬ë·° ì–¸ì–´ ê·œì¹™ íŒŒì¼ ì‘ì„±
    review_instr = Path(".github/instructions/review-language.instructions.md")
    review_content = dedent(
        """\
        ---
        applyTo: "**"
        ---

        All GitHub Copilot code review comments must be written in Korean (í•œêµ­ì–´).
        - This rule applies to all paths in this repository.
        - If any other instruction conflicts with this rule, this repository-level rule takes precedence.
        """
    )
    try:
        review_instr.write_text(review_content, encoding="utf-8", newline="\n")
        print(f"âœ… {review_instr} ì—…ë°ì´íŠ¸ ì™„ë£Œ")
    except Exception as e:
        print(f"âŒ {review_instr} ì‘ì„± ì‹¤íŒ¨: {e}")
        return False

    print("ğŸ‰ ë¬¸ì„œ ë™ê¸°í™” ì™„ë£Œ!")
    print("\nğŸ“‹ ì–¸ì–´ ê·œì¹™ ìš”ì•½:")
    print("- ì½”ë“œ/ì£¼ì„/ì»¤ë°‹: í•œêµ­ì–´")
    print("- ë³€ìˆ˜ëª…/í•¨ìˆ˜ëª…/API: ì˜ì–´")
    print("- ë² ì´ìŠ¤ ë¬¸ì„œ(docs/agents_base_en.md): ì˜ë¬¸ (SSOT)")
    print("- Replica: AGENTS/CLAUDE/GEMINI/Copilot ì§€ì¹¨ì€ ë² ì´ìŠ¤ì—ì„œ ìë™ ìƒì„±")

    return True


if __name__ == "__main__":
    success = sync_docs()
    exit(0 if success else 1)

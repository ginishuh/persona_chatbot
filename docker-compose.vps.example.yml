# Example docker-compose for VPS deployment
# Copy to docker-compose.yml and fill environment values or use an env file.
version: "3.9"
services:
  persona-chatbot:
    image: persona_chatbot:latest
    container_name: persona_chatbot_server
    restart: unless-stopped
    ports:
      - "0.0.0.0:8765:8765"  # WebSocket
      - "0.0.0.0:9000:9000"  # HTTP
    volumes:
      - ./STORIES:/app/STORIES
      - ./server:/app/server
      - ./web:/app/web
      - ./data:/app/data
      - ./persona_data:/app/persona_data
      - ./chatbot_workspace:/app/chatbot_workspace
      - ${FACTORY_AUTH_DIR:-$HOME/.factory}:/home/node/.factory
      - ${CLAUDE_AUTH_DIR:-$HOME/.claude}:/home/node/.claude
      - ${GEMINI_AUTH_DIR:-$HOME/.gemini}:/home/node/.gemini
    environment:
      - PYTHONUNBUFFERED=1
      - HOME=/home/node
      - CLAUDE_PATH=${CLAUDE_PATH:-claude}
      - DROID_PATH=${DROID_PATH:-droid}
      - GEMINI_PATH=${GEMINI_PATH:-gemini}
      - APP_BIND_HOST=${APP_BIND_HOST:-0.0.0.0}
      - APP_LOGIN_USERNAME=${APP_LOGIN_USERNAME:-}
      # If you want to require login on VPS, set APP_LOGIN_PASSWORD
      - APP_LOGIN_PASSWORD=${APP_LOGIN_PASSWORD:-}
      - APP_JWT_SECRET=${APP_JWT_SECRET:-}
      - APP_JWT_TTL=${APP_JWT_TTL:-604800}
      - APP_ACCESS_TTL=${APP_ACCESS_TTL:-3600}
      - APP_REFRESH_TTL=${APP_REFRESH_TTL:-2592000}
      - APP_REFRESH_ROTATE=${APP_REFRESH_ROTATE:-1}
      - APP_JWT_GRACE_MINUTES=${APP_JWT_GRACE_MINUTES:-60}
      - APP_LOGIN_MAX_ATTEMPTS=${APP_LOGIN_MAX_ATTEMPTS:-5}
      - APP_LOGIN_LOCK_MINUTES=${APP_LOGIN_LOCK_MINUTES:-15}
      - APP_PUBLIC_WS_URL=${APP_PUBLIC_WS_URL:-}
      - FACTORY_API_KEY=${FACTORY_API_KEY:-}
      - DROID_SKIP_PERMISSIONS_UNSAFE=1
      - FACTORY_AUTO_UPDATE=0
      - APP_GIT_SYNC_MODE=host
    stdin_open: true
    tty: true

# NOTES:
# - For production, generate a strong APP_JWT_SECRET and do NOT commit it to the repo.
# - Use a proper process manager or systemd unit to run docker-compose on VPS.
# - Consider using a reverse proxy (nginx) in front for TLS termination.
